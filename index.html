<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Device Management and Remove Button</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Fullscreen map */
        #map {
            height: 100vh;
            width: calc(100vw - 300px); /* Leave space for the sidebar */
            margin: 0;
            padding: 0;
            position: absolute;
            left: 0;
        }

        /* Sidebar styling */
        #sidebar {
            width: 300px;
            height: 100vh;
            background-color: #f5f5f5;
            box-shadow: 2px 0px 5px rgba(0, 0, 0, 0.1);
            padding: 16px;
            font-family: 'Roboto', sans-serif;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 1000;
        }

        #sidebar h3 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
        }

        #sidebar .device-list {
            margin: 16px 0;
            max-height: 400px;
            overflow-y: auto; /* Allow scrolling if list is long */
        }

        #sidebar .device-list-item {
            background-color: #fff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #sidebar .device-list-item h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        #sidebar .device-list-item p {
            font-size: 14px;
            color: #666;
        }

        #sidebar .device-list-item button {
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        #sidebar form {
            background-color: #fff;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
        }

        #sidebar form input,
        #sidebar form button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #sidebar form button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        /* Custom marker icon */
        .custom-icon {
            width: 40px;
            height: 40px;
        }

        /* Material-style card for tooltip */
        .material-card {
            background-color: #fff;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 16px;
            max-width: 250px;
            font-family: 'Roboto', sans-serif;
        }

        .material-card h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .material-card p {
            margin: 8px 0;
            font-size: 14px;
            color: #666;
        }

        /* Customize tooltip */
        .leaflet-tooltip.custom-tooltip {
            background: none;
            border: none;
            box-shadow: none;
        }
    </style>
</head>
<body>

    <!-- Sidebar for managing devices -->
    <div id="sidebar">
        <h3>Manage Devices</h3>
        
        <!-- Form to add new devices -->
        <form id="device-form">
            <input type="text" id="device-name" placeholder="Device Name" required>
            <input type="text" id="device-id" placeholder="Device ID" required>
            <input type="text" id="device-lat" placeholder="Latitude" required>
            <input type="text" id="device-lng" placeholder="Longitude" required>
            <button type="button" id="add-device">Add Device</button>
        </form>

        <!-- Device list -->
        <div class="device-list" id="device-list"></div>
    </div>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize the map and set its view to a specified location and zoom level
        var map = L.map('map').setView([16.566233, 121.262634], 7)  // Coordinates for London

        // Load and display a tile layer on the map (OpenStreetMap tiles)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Array to store the markers
        var markers = {};

        // Create a custom icon for the pinpoint
        var customIcon = L.icon({
            iconUrl: 'truck.png',  // Example icon
            iconSize: [40, 40],  // Icon size
            iconAnchor: [20, 40],  // Anchor the icon at the center bottom
            popupAnchor: [0, -40]  // Popup position relative to the icon
        });

        function setMapView(lat, lng) {
            map.setView([lat, lng], 13);
        }

        // Function to add or update a device marker on the map and update the device list
        function addDevice(name, id, lat, lng) {
            if (markers[id]) {
                // Update existing marker's position
                markers[id].setLatLng([lat, lng]);
                // Update tooltip content
                markers[id].getTooltip().setContent(`
                    <div class="material-card">
                        <h4>Device: ${name}</h4>
                        <p><strong>Device ID:</strong> ${id}</p>
                        <p><strong>Location:</strong> ${lat}, ${lng}</p>
                    </div>
                `);
            } else {
                // Create a new marker
                var marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                
                // Create Material-style tooltip content
                var tooltipContent = `
                    <div class="material-card">
                        <h4>Device: ${name}</h4>
                        <p><strong>Device ID:</strong> ${id}</p>
                        <p><strong>Location:</strong> ${lat}, ${lng}</p>
                    </div>
                `;
                
                // Bind the tooltip to the marker
                marker.bindTooltip(tooltipContent, { 
                    permanent: false, 
                    direction: 'top',
                    className: 'custom-tooltip',
                    offset: [0, -40]
                }).openTooltip();

                // Store the marker by device ID for easy removal
                markers[id] = marker;

                // Add the device to the device list in the sidebar
                addDeviceToSidebar(name, id, lat, lng);
            }
        }

        // Function to add device to sidebar
        function addDeviceToSidebar(name, id, lat, lng) {
            var deviceList = document.getElementById('device-list');
            var deviceItem = document.createElement('div');
            deviceItem.className = 'device-list-item';
            deviceItem.onclick = `setMapView(lat, lng)`;
            deviceItem.setAttribute('data-id', id);
            deviceItem.innerHTML = `
                <h4>${name}</h4>
                <p>ID: ${id}</p>
                <p>Location: ${lat}, ${lng}</p>
                <button class="remove-device">Remove</button>
            `;
            deviceList.appendChild(deviceItem);

            // Attach remove functionality to the remove button
            deviceItem.querySelector('.remove-device').addEventListener('click', function() {
                removeDevice(id, deviceItem);
            });
        }

        // Function to remove a device
        function removeDevice(id, deviceElement) {
            // Remove the marker from the map
            if (markers[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }

            // Remove the device from the backend
            fetch(`/api/devices/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error deleting device');
                }
                deviceElement.remove(); // Remove the device item from the list
            })
            .catch(error => console.error('Error:', error));
        }

        // Handle the add device button click event
        document.getElementById('add-device').addEventListener('click', function() {
            var name = document.getElementById('device-name').value;
            var id = document.getElementById('device-id').value;
            var lat = parseFloat(document.getElementById('device-lat').value);
            var lng = parseFloat(document.getElementById('device-lng').value);

            // Add the new device to the backend
            fetch('/api/devices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, latitude: lat, longitude: lng })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error adding device');
                }
                return response.json();
            })
            .then(newDevice => {
                // Add the new device to the map
                addDevice(newDevice.name, newDevice._id, newDevice.latitude, newDevice.longitude);
                // Clear the input fields
                document.getElementById('device-name').value = '';
                document.getElementById('device-id').value = '';
                document.getElementById('device-lat').value = '';
                document.getElementById('device-lng').value = '';
            })
            .catch(error => console.error('Error:', error));
        });

        // Fetch devices every 2 seconds
        setInterval(() => {
            fetchDevices();
        }, 2000);

        // Fetch devices from the backend
        // Fetch devices from the backend
        function fetchDevices() {
            fetch('/api/devices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error fetching devices');
                    }
                    return response.json();
                })
                .then(devices => {
                    console.log(devices);  // Log the devices to check if they are being fetched correctly
                    // Clear current markers and device list
                    for (const id in markers) {
                        map.removeLayer(markers[id]);
                    }
                    markers = {}; // Reset markers
                    document.getElementById('device-list').innerHTML = ''; // Clear device list

                    // Re-add devices
                    devices.forEach(device => {
                        addDevice(device.name, device._id, device.latitude, device.longitude);
                    });
                })
                .catch(error => console.error('Error fetching devices:', error));
        }

    </script>
</body>
</html>
